# Agents & Workflows

## Overview

Glee separates two concepts for subagent orchestration:

1. **Agents**: Reusable workers (humans or AI can define agents)
2. **Workflows**: Orchestration of agent calls (humans or AI can define workflows)

**AI-native**: Agents can define other agents and workflows, enabling fully autonomous operation.

This is simpler than Claude Code's multiple markdown file types (AGENTS.md, .claude/agents/*.md, plugins, skills).

## Comparison with Claude Code

```
Claude Code:
├── AGENTS.md              # Project instructions
├── .claude/agents/*.md    # Subagents
├── plugins                # External integrations
└── skills                 # Task-specific capabilities

Glee (simpler):
├── AGENTS.md              # Project instructions (same)
├── .glee/agents/*.yml     # Reusable workers
└── .glee/workflows/*.yml  # Orchestration (optional)
```

**Key insight**: All these concepts are just markdown files in Claude Code. Glee uses a unified YAML format and separates workers (agents) from orchestration (workflows).

## Agents

Agents are **reusable workers**. They can be defined by:
- **Humans**: Manual creation of `.glee/agents/*.yml`
- **AI**: Agents can define other agents (AI-native, fully autonomous)

### Format

```yaml
# .glee/agents/security-scanner.yml
name: security-scanner
description: Scan code for security vulnerabilities

# Which CLI to use (optional, auto-selects if not specified)
agent: codex

# The system prompt
prompt: |
  You are a security expert. Analyze the given code for:
  - SQL injection
  - XSS vulnerabilities
  - Authentication issues
  - Secrets in code

  Report findings with severity levels: HIGH, MEDIUM, LOW.

# Optional settings
timeout_mins: 5
max_output_kb: 50
```

### Import from Other Formats

```bash
# Import from Claude Code
glee agents import --from claude
# Reads .claude/agents/*.md → .glee/agents/*.yml

# Import from Gemini CLI
glee agents import --from gemini
# Reads .gemini/agents/*.toml → .glee/agents/*.yml
```

Import is **one-way** (source → glee). Glee never writes back to `.claude/` or `.gemini/`.

### Source Tracking

Imported agents have a `source` field:

```yaml
name: security-reviewer
description: Security code reviewer
agent: claude
prompt: |
  You are a security expert...

# Only present for imported agents
source:
  from: claude
  file: .claude/agents/security-reviewer.md
  imported_at: "2025-01-09T15:00:00Z"
```

Native Glee agents don't have a `source` field.

## Workflows

Workflows define **how agents work together**. They can be defined by humans OR generated by AI.

### Format

```yaml
# .glee/workflows/full-review.yml
name: full-review
description: Complete code review with security and performance analysis

# Sequence of steps
steps:
  - agent: security-scanner
    inputs:
      target_file: ${target}

  - agent: performance-analyzer
    inputs:
      target_file: ${target}

  - agent: code-reviewer
    inputs:
      target_file: ${target}
      security_report: ${steps[0].output}
      performance_report: ${steps[1].output}

# How to run steps
execution: sequential  # or: parallel, dag
```

### Parallel Execution

```yaml
# .glee/workflows/parallel-scan.yml
name: parallel-scan
description: Run multiple scanners in parallel

steps:
  - agent: security-scanner
    parallel_group: scanners

  - agent: lint-checker
    parallel_group: scanners

  - agent: type-checker
    parallel_group: scanners

  # This runs after all scanners complete
  - agent: report-aggregator
    inputs:
      reports: ${parallel_group.scanners.outputs}

execution: parallel
```

### Nested Workflows

Workflows can contain other workflows. This enables modular composition.

```yaml
# .glee/workflows/run-restaurant.yml
name: run-restaurant
description: Daily operations for a restaurant

steps:
  - workflow: accounting          # Another workflow
  - workflow: purchasing          # Another workflow
  - workflow: serve-customers     # Another workflow (more specific scope)
  - workflow: cleaning            # Another workflow
```

```yaml
# .glee/workflows/serve-customers.yml
name: serve-customers
description: Handle customer service flow

steps:
  - agent: order-taker
    inputs:
      channel: ${channel}  # in-store, drive-thru, app

  - agent: payment-processor
    inputs:
      order: ${steps[0].output}

  - agent: food-preparer
    inputs:
      order: ${steps[0].output}

  - agent: delivery-handler
    inputs:
      order: ${steps[0].output}
      food: ${steps[2].output}
```

**Key insight**: `serve-customers` is a standalone workflow with its own scope and detailed steps. The parent workflow (`run-restaurant`) doesn't need to know the details — it just invokes the sub-workflow.

This is how complex systems are built:
- **Agents**: Atomic workers (do one thing)
- **Workflows**: Compose agents and other workflows (recursive structure)

### AI-Generated Workflows

The main agent (Claude, etc.) can generate workflows on-the-fly:

```python
# Main agent creates a workflow dynamically
glee_task(
    description="Review auth changes",
    prompt="Review the authentication changes for security and performance",
    workflow={
        "steps": [
            {"agent": "security-scanner", "inputs": {"focus": "auth"}},
            {"agent": "performance-analyzer", "inputs": {"focus": "auth"}}
        ],
        "execution": "parallel"
    }
)
```

This allows AI to compose agents without human-defined workflow files.

## Tools

See [tools.md](tools.md) for the full Tools documentation.

Tools are external APIs (`.glee/tools/*.yml`) that agents can use. Agents can also create new tools (AI-native).

## MCP Tools

### `glee_task`

Spawn an agent to execute a task:

```python
glee_task(
    description="Find API endpoints",           # Short (3-5 words)
    prompt="Search for all REST endpoints...",  # Full task prompt
    agent_name="explore",                       # Optional: subagent or CLI name
    background=False,                           # Optional: run in background
    session_id=None                             # Optional: resume session
)
```

### `glee_workflow` (future)

Execute a named workflow:

```python
glee_workflow(
    name="full-review",
    inputs={"target": "src/api/auth.py"}
)
```

### `glee_agents_list`

List available agents:

```python
glee_agents_list()
# Returns:
# [
#   {"name": "security-scanner", "source": "native"},
#   {"name": "code-reviewer", "source": "claude"},
#   {"name": "performance-analyzer", "source": "gemini"}
# ]
```

## Context Injection

When spawning an agent, Glee automatically injects context:

1. **AGENTS.md**: Project instructions from root directory
2. **Memories**: Relevant memories from `glee_memory_search`
3. **Session history**: Previous conversation (if resuming)

```python
# Glee does this internally:
agents_md = read_file("AGENTS.md")
memories = glee_memory_search(query=task_description)
session = load_session(session_id) if session_id else None

full_prompt = f"""
<project_instructions>
{agents_md}
</project_instructions>

<project_context>
{memories}
</project_context>

{session_history if session else ""}

{user_prompt}
"""
spawn_subprocess(agent_cli, full_prompt)
```

## Session Management

CLI agents (codex, claude, gemini) are stateless. Glee stores conversation history:

```
.glee/sessions/
└── task-a1b2c3d4.json
```

```json
{
  "session_id": "task-a1b2c3d4",
  "agent_name": "codex",
  "created_at": "2025-01-09T15:00:00",
  "messages": [
    {"role": "user", "content": "Search for all REST endpoints"},
    {"role": "assistant", "content": "Found 5 endpoints..."}
  ]
}
```

Resume a session:

```python
glee_task(
    session_id="task-a1b2c3d4",
    prompt="Now document each endpoint"
)
# Agent receives full conversation history
```

## Implementation Phases

### Phase 1: glee_task (v0.3)
- [x] Design docs (subagents.md, workflows.md, tools.md)
- [x] `glee_task` MCP tool - spawn CLI agents (codex, claude, gemini)
- [x] Session management (generate ID, store context)
- [x] Context injection (AGENTS.md + memories)
- [x] Basic logging to `.glee/stream_logs/`

### Phase 2: Tools (v0.4)
- [ ] `.glee/tools/*.yml` format
- [ ] `glee_tool` MCP tool (execute tools)
- [ ] `glee_tool_create` MCP tool (AI creates tools)
- [ ] Built-in tools: web_search, http_request

### Phase 3: Agents (v0.5)
- [ ] `.glee/agents/*.yml` format
- [ ] `glee_agent_create` MCP tool (AI creates agents)
- [ ] `glee agents import` from Claude/Gemini formats
- [ ] Agent selection heuristics

### Phase 4: Workflows (v0.6+)
- [ ] `.glee/workflows/*.yml` format
- [ ] `glee_workflow` MCP tool
- [ ] Nested workflows
- [ ] Parallel/DAG execution
