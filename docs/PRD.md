# Glee - Multi-Agent Code Collaboration Platform

> Glee (n.): 1. æ¬¢ä¹ 2. åˆå”±å›¢ (Glee Club) â€” å¤šä¸ª AI åƒåˆå”±å›¢ä¸€æ ·åä½œï¼Œè®©å†™ä»£ç å˜å¾—æ„‰å¿«ã€‚

## èƒŒæ™¯ä¸é—®é¢˜

Claude Code åœ¨é•¿æ—¶é—´å·¥ä½œåï¼Œç”±äº context ç´¯ç§¯ï¼Œå¯èƒ½æ— æ³•å‘ç°è‡ªèº«ä»£ç çš„ç¼ºé™·ã€‚é€šè¿‡å¼•å…¥ Codex ä½œä¸ºç‹¬ç«‹çš„ code reviewerï¼Œå¯ä»¥è·å¾—"ç¬¬äºŒåŒçœ¼ç›"çš„æ•ˆæœï¼Œæå‡ä»£ç è´¨é‡ã€‚

## ç›®æ ‡

åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨åŒ–çš„ code review å¾ªç¯ agentï¼Œå®ç°ï¼š
- Claude Code å†™ä»£ç  â†’ Codex å®¡æŸ¥ â†’ Claude Code ä¿®æ”¹ â†’ å¾ªç¯ç›´åˆ°é€šè¿‡æˆ–è¾¾åˆ°ä¸Šé™

## é•¿æœŸæ„¿æ™¯ï¼šMulti-Agent åä½œå¹³å°

å½“å‰é¡¹ç›®æ˜¯ç¬¬ä¸€æ­¥ï¼Œæœªæ¥å¯æ‰©å±•ä¸ºå¤š AI åä½œå¹³å°ï¼š

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         LangGraph Orchestrator       â”‚
                    â”‚         (çŠ¶æ€ç®¡ç† + æµç¨‹ç¼–æ’)         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼             â–¼               â–¼               â–¼             â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Claude  â”‚  â”‚  Codex  â”‚    â”‚ Gemini  â”‚    â”‚   GLM   â”‚    â”‚ OpenCodeâ”‚
   â”‚  Code   â”‚  â”‚         â”‚    â”‚         â”‚    â”‚ (ä¾¿å®œ)  â”‚    â”‚         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœªæ¥å¯èƒ½çš„å·¥ä½œæµ**ï¼š
- Codex åš plan â†’ Claude Code æ‰§è¡Œ
- Claude Code å†™ä»£ç  â†’ Codex review
- ç®€å•ä»»åŠ¡ â†’ GLMï¼ˆæˆæœ¬ä½ï¼‰
- å¤æ‚ä»»åŠ¡ â†’ Claude/Codexï¼ˆèƒ½åŠ›å¼ºï¼‰
- å¤šä¸ª AI æŠ•ç¥¨å†³ç­–
- ä¸åŒ AI äº’ç›¸ review

---

## Future TODO

### YOLO æ¨¡å¼ (å…¨è‡ªåŠ¨æ¨¡å¼)

ç”¨æˆ·æä¾›ä¸€ä¸ªéœ€æ±‚æ–‡æ¡£ï¼Œç³»ç»Ÿå…¨è‡ªåŠ¨å®Œæˆï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  éœ€æ±‚æ–‡æ¡£    â”‚ â”€â”€â–¶ â”‚  Claude Code â”‚ â”€â”€â–¶ â”‚   Codex     â”‚
â”‚  (PRD/Spec) â”‚     â”‚  ç”Ÿæˆä»£ç     â”‚     â”‚   Review    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â–²                    â”‚
                           â”‚    æœ‰é—®é¢˜           â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼ æ— é—®é¢˜
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚   å®Œæˆï¼     â”‚
                           â”‚  è¾“å‡ºä»£ç     â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹ç‚¹**ï¼š
- æ— éœ€ human-in-the-loop
- å…¨è‡ªåŠ¨è¿­ä»£ç›´åˆ°é€šè¿‡æˆ–è¾¾ä¸Šé™
- é€‚åˆæ˜ç¡®çš„éœ€æ±‚ã€ä½é£é™©çš„ä»»åŠ¡
- "Write once, review automatically, deploy confidently"

**è§¦å‘æ–¹å¼**ï¼š
```bash
/yolo path/to/spec.md
```

**çŠ¶æ€**ï¼šğŸ”® Future

## çº¦æŸæ¡ä»¶

1. **ä½¿ç”¨æœ¬åœ° CLI**ï¼šä½¿ç”¨ `claude` å’Œ `codex` CLIï¼Œä¸ä½¿ç”¨ SDK/APIï¼ˆé¿å…é¢„ç®—çˆ†ç‚¸ï¼‰
2. **æœ€å¤§è¿­ä»£æ¬¡æ•°**ï¼š10 è½®ï¼Œé˜²æ­¢æ— é™å¾ªç¯
3. **Human-in-the-loop**ï¼šæ”¯æŒäººç±»ä»‹å…¥å›ç­” open questions

## æŠ€æœ¯æ ˆ

| ç»„ä»¶ | é€‰æ‹© | ç†ç”± |
|------|------|------|
| è¯­è¨€ | TypeScript | ç±»å‹å®‰å…¨ï¼Œä¸ Claude Code åŒç”Ÿæ€ |
| Agent æ¡†æ¶ | LangGraph | çŠ¶æ€ç®¡ç†ã€æµç¨‹ç¼–æ’ã€human-in-the-loopã€å¯æ‰©å±• |
| æ¥å£å±‚ | MCP Server | Claude Code åŸç”Ÿæ”¯æŒ |
| æŒä¹…åŒ– | æœ¬åœ° JSON / TiDB Cloud | åˆ†å±‚å­˜å‚¨ï¼Œå¯é€‰å‡çº§ |

---

## æ¶æ„è®¾è®¡

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|------|------|------|--------|
| A. Shell è„šæœ¬ | ç®€å•ã€ç›´æ¥è°ƒç”¨ CLI | å¤æ‚é€»è¾‘éš¾å¤„ç†ã€è§£æå›°éš¾ | â­â­ |
| B. Python è„šæœ¬ | çµæ´»ã€æ˜“äºæ‰©å±• | éœ€è¦é¢å¤–ä¾èµ– | â­â­â­â­ |
| C. Claude Code Hook | åŸç”Ÿé›†æˆã€è‡ªåŠ¨è§¦å‘ | åŠŸèƒ½å—é™ã€é…ç½®å¤æ‚ | â­â­â­ |
| D. MCP Server | Claude Code åŸç”Ÿè°ƒç”¨ | å¼€å‘æˆæœ¬é«˜ | â­â­â­â­â­ |

### æ¨èæ–¹æ¡ˆï¼šD - MCP Server

**åŸå› **ï¼š
- Claude Code å¯ä»¥ç›´æ¥è°ƒç”¨ MCP å·¥å…·ï¼Œæ— éœ€è·³å‡ºå½“å‰å·¥ä½œæµ
- å¯ä»¥ä¿æŒå¯¹è¯ä¸Šä¸‹æ–‡ï¼Œä¾¿äº human-in-the-loop
- æ¶æ„æ¸…æ™°ï¼Œæ˜“äºæ‰©å±•

---

## è¯¦ç»†è®¾è®¡

### æ ¸å¿ƒæ¶æ„

**è®¾è®¡åŸåˆ™**ï¼šAgent åªè´Ÿè´£è°ƒç”¨ Codex å’Œç®¡ç†çŠ¶æ€ï¼Œä»£ç ä¿®æ”¹ç”±å½“å‰ Claude Code å¯¹è¯å®Œæˆã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ· â†â†’ Claude Code                       â”‚
â”‚                    (å½“å‰å¯¹è¯ï¼Œä¿æŒäº¤äº’)                        â”‚
â”‚                                                              â”‚
â”‚   èŒè´£ï¼š                                                      â”‚
â”‚   - ç¼–å†™/ä¿®æ”¹ä»£ç ï¼ˆä½¿ç”¨ Edit/Write å·¥å…·ï¼‰                      â”‚
â”‚   - ä¸ç”¨æˆ·äº¤äº’                                                â”‚
â”‚   - è°ƒç”¨ Agent è·å– review åé¦ˆ                               â”‚
â”‚   - æ ¹æ®åé¦ˆä¿®æ”¹ä»£ç                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ è°ƒç”¨ MCP å·¥å…·
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Code Review Agent (MCP Server)               â”‚
â”‚                                                              â”‚
â”‚   èŒè´£ï¼š                                                      â”‚
â”‚   - è°ƒç”¨ Codex CLI è·å– review åé¦ˆ                          â”‚
â”‚   - ç®¡ç†è¿­ä»£æ¬¡æ•°ï¼ˆæœ€å¤š 10 è½®ï¼‰                                 â”‚
â”‚   - ä¿å­˜ review å†å²åˆ°å­˜å‚¨                                    â”‚
â”‚   - åˆ¤æ–­ç»ˆæ­¢æ¡ä»¶ï¼ˆLGTM / è¾¾åˆ°ä¸Šé™ï¼‰                            â”‚
â”‚   - æ£€æµ‹éœ€è¦äººç±»å›ç­”çš„é—®é¢˜                                     â”‚
â”‚                                                              â”‚
â”‚   ä¸è´Ÿè´£ï¼š                                                    â”‚
â”‚   - ä¿®æ”¹ä»£ç ï¼ˆç”±å½“å‰ Claude Code å¯¹è¯å®Œæˆï¼‰                    â”‚
â”‚   - ä¸ç”¨æˆ·ç›´æ¥äº¤äº’ï¼ˆé€šè¿‡ Claude Code ä¸­è½¬ï¼‰                    â”‚
â”‚                           â”‚                                  â”‚
â”‚                           â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Codex CLI Interface                                 â”‚    â”‚
â”‚  â”‚  - subprocess è°ƒç”¨ codex cli                         â”‚    â”‚
â”‚  â”‚  - è§£æ JSON è¾“å‡º                                    â”‚    â”‚
â”‚  â”‚  - æ•è· review åé¦ˆ                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆä¸æ–°å¼€ Claude Code CLI è¿›ç¨‹ï¼Ÿ**
- å½“å‰å¯¹è¯å·²ç»æœ‰å®Œæ•´çš„ä¸Šä¸‹æ–‡
- ç”¨æˆ·å¯ä»¥çœ‹åˆ°æ¯ä¸€è½®ä¿®æ”¹çš„è¿‡ç¨‹
- é¿å…é»‘ç›’æ“ä½œï¼Œä¿æŒé€æ˜
- äººå·¥å¯ä»¥éšæ—¶ä»‹å…¥è°ƒæ•´

### å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç”¨æˆ·è¯·æ±‚ï¼šå¸®æˆ‘å®ç° XXX åŠŸèƒ½                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Claude Codeï¼ˆæˆ‘ï¼‰ç¼–å†™ä»£ç                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Claude Code è°ƒç”¨ Agent: get_review(files)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Agent è°ƒç”¨ Codex CLIï¼Œè·å– review åé¦ˆ                        â”‚
â”‚     - iteration++                                                â”‚
â”‚     - ä¿å­˜å†å²                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Codex åé¦ˆç»“æœ      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                      â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ has_issues    â”‚    â”‚ needs_human     â”‚    â”‚ approved      â”‚
â”‚ æœ‰æ”¹è¿›å»ºè®®     â”‚    â”‚ éœ€è¦äººç±»å†³ç­–     â”‚    â”‚ LGTM é€šè¿‡     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚                      â”‚
        â–¼                     â–¼                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚ iteration<10? â”‚    â”‚ è¿”å›é—®é¢˜ç»™      â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ Claude Code     â”‚             â”‚
   yes  â”‚  no        â”‚ â†’ é—®ç”¨æˆ·        â”‚             â”‚
        â”‚  â”‚         â”‚ â†’ ç”¨æˆ·å›ç­”      â”‚             â”‚
        â”‚  â”‚         â”‚ â†’ ç»§ç»­ review   â”‚             â”‚
        â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
        â”‚  â”‚                  â”‚                      â”‚
        â–¼  â–¼                  â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                      â”‚
â”‚ è¿”å›åé¦ˆç»™        â”‚         â”‚                      â”‚
â”‚ Claude Code       â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
        â”‚                                            â”‚
        â–¼                                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚ Claude Codeï¼ˆæˆ‘ï¼‰  â”‚                                â”‚
â”‚ æ ¹æ®åé¦ˆä¿®æ”¹ä»£ç    â”‚                                â”‚
â”‚ å›åˆ°æ­¥éª¤ 3        â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
                                                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  END: è¿”å›æœ€ç»ˆç»“æœç»™ç”¨æˆ·                                          â”‚
â”‚  - approved: "Code review é€šè¿‡ï¼"                                â”‚
â”‚  - max_iterations: "å·²è¾¾ 10 è½®ä¸Šé™ï¼Œæœ€ååé¦ˆï¼š..."                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‚¹**ï¼š
- ä»£ç ä¿®æ”¹å§‹ç»ˆåœ¨å½“å‰å¯¹è¯ä¸­å®Œæˆï¼ˆç”¨æˆ·å¯è§ï¼‰
- Agent åªè´Ÿè´£è°ƒç”¨ Codex å’Œç®¡ç†çŠ¶æ€
- å¾ªç¯ç”± Claude Code é©±åŠ¨ï¼Œä½†è¿­ä»£æ¬¡æ•°ç”± Agent è¿½è¸ª

---

## è‡ªåŠ¨åŒ–è§¦å‘æœºåˆ¶

### é—®é¢˜ï¼šClaude Code å¦‚ä½•çŸ¥é“ä½•æ—¶è°ƒç”¨ Agentï¼Ÿ

Claude Code ä¸ä¼šè‡ªåŠ¨çŸ¥é“è¦è°ƒç”¨è¿™ä¸ª Agentï¼Œéœ€è¦æ˜¾å¼é…ç½®ã€‚

| æ–¹æ¡ˆ | å®ç°æ–¹å¼ | è‡ªåŠ¨åŒ–ç¨‹åº¦ |
|------|----------|------------|
| A. ç”¨æˆ·æ˜¾å¼è§¦å‘ | ç”¨æˆ·è¯´"review ä¸€ä¸‹" | æ‰‹åŠ¨ |
| B. CLAUDE.md è§„åˆ™ | å†™æ˜"å®Œæˆä»£ç åè°ƒç”¨ review" | åŠè‡ªåŠ¨ |
| C. Slash Command | `/review` è§¦å‘ | æ‰‹åŠ¨ä½†æ–¹ä¾¿ |
| D. Hook | å†™å®Œä»£ç è‡ªåŠ¨è§¦å‘ | å…¨è‡ªåŠ¨ |

### é—®é¢˜ï¼šClaude Code å¦‚ä½•çŸ¥é“ä½•æ—¶åœæ­¢è¿­ä»£ï¼Ÿ

Agent è¿”å›æ˜ç¡®çš„çŠ¶æ€ï¼ŒClaude Code æ ¹æ®çŠ¶æ€å†³å®šä¸‹ä¸€æ­¥ï¼š

```typescript
interface ReviewResult {
  status: "approved" | "has_issues" | "needs_human" | "max_iterations";
  iteration: number;
  feedback?: string;
  questions?: string[];
}
```

| çŠ¶æ€ | Claude Code è¡Œä¸º |
|------|------------------|
| `approved` | åœæ­¢ï¼Œå‘Šè¯‰ç”¨æˆ·"é€šè¿‡äº†" |
| `has_issues` | æ ¹æ® feedback ä¿®æ”¹ä»£ç ï¼Œå†æ¬¡è°ƒç”¨ review |
| `needs_human` | å°†é—®é¢˜å±•ç¤ºç»™ç”¨æˆ·ï¼Œç­‰å¾…å›ç­” |
| `max_iterations` | åœæ­¢ï¼Œå‘Šè¯‰ç”¨æˆ·å·²è¾¾ä¸Šé™ |

### é—®é¢˜ï¼šè¿™æ˜¯ Agent è¿˜æ˜¯ MCP Serverï¼Ÿ

**Bothï¼Œè§’è‰²ä¸åŒ**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Claude Code = ä¸» Agent                              â”‚
â”‚  - è‡ªä¸»å†³ç­–ã€å†™ä»£ç ã€åè°ƒæµç¨‹                         â”‚
â”‚  - æ ¹æ® review ç»“æœå†³å®šæ˜¯å¦ç»§ç»­                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ è°ƒç”¨
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Code Review = Stateful Tool (æœ‰çŠ¶æ€çš„å·¥å…·)          â”‚
â”‚  - æŠ€æœ¯å®ç°ï¼šMCP Server                              â”‚
â”‚  - æ¦‚å¿µè§’è‰²ï¼šè¾…åŠ© Agentï¼ˆç®¡ç†çŠ¶æ€ã€åšåˆ¤æ–­ï¼‰           â”‚
â”‚  - ç‰¹ç‚¹ï¼šä¸è‡ªä¸»ï¼Œéœ€è¦è¢«è°ƒç”¨                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨èæ–¹æ¡ˆï¼šåŒè§¦å‘æœºåˆ¶

#### 1. æ‰‹åŠ¨è§¦å‘ï¼š`/review` Slash Command

ç”¨æˆ·å¯ä»¥éšæ—¶æ‰‹åŠ¨è§¦å‘ reviewï¼š

```
ç”¨æˆ·: /review
Claude Code: è°ƒç”¨ Agent è·å– Codex review...
```

#### 2. åŠè‡ªåŠ¨è§¦å‘ï¼šStop Hook + è¯¢é—®

å½“ Claude Code å®Œæˆå“åº”ä¸”æœ‰ä»£ç ä¿®æ”¹æ—¶ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦éœ€è¦ reviewï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ£€æµ‹åˆ°ä»£ç ä¿®æ”¹ï¼Œæ˜¯å¦éœ€è¦ Codex review?                       â”‚
â”‚                                                              â”‚
â”‚  [No] (é»˜è®¤ï¼ŒæŒ‰ Enter è·³è¿‡)    [Yes]                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Hook é…ç½®** (`~/.claude/settings.json` æˆ– `.claude/settings.json`)ï¼š

```json
{
  "hooks": {
    "Stop": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "/path/to/clean-code-agent/scripts/ask-review.sh"
          }
        ]
      }
    ]
  }
}
```

**ask-review.sh è„šæœ¬é€»è¾‘**ï¼š

```bash
#!/bin/bash

# è¯»å– hook è¾“å…¥
input=$(cat)

# æ£€æŸ¥æ˜¯å¦æœ‰ä»£ç ä¿®æ”¹ï¼ˆæ£€æŸ¥ Edit/Write å·¥å…·è°ƒç”¨ï¼‰
has_code_change=$(echo "$input" | jq -r '
  .tool_results // [] |
  any(.tool_name == "Edit" or .tool_name == "Write")
')

# æ£€æŸ¥æ˜¯å¦æ­£åœ¨ review å¾ªç¯ä¸­ï¼ˆé˜²æ­¢å¾ªç¯ï¼‰
if [ -f ".clean-code-agent/review.lock" ]; then
    exit 0
fi

# å¦‚æœæœ‰ä»£ç ä¿®æ”¹ï¼Œè¯¢é—®ç”¨æˆ·
if [ "$has_code_change" = "true" ]; then
    # è¿”å› JSON è®© Claude Code è¯¢é—®ç”¨æˆ·
    echo '{"action": "ask_user", "question": "æ˜¯å¦éœ€è¦ Codex review?", "default": "no"}'
fi

exit 0
```

#### ä¸ºä»€ä¹ˆè¿™ä¸ªæ–¹æ¡ˆå¥½ï¼Ÿ

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| ä¸æ‰“æ‰° | é»˜è®¤ Noï¼ŒæŒ‰ Enter å°±è·³è¿‡ |
| æœ‰æé†’ | ç”¨æˆ·ä¸ä¼šå¿˜è®°å¯ä»¥ review |
| æ— å¾ªç¯ | ç”¨æˆ·ä¸»åŠ¨é€‰æ‹©ï¼Œlock æ–‡ä»¶é˜²æŠ¤ |
| çµæ´» | å¯ä»¥éšæ—¶ `/review` æ‰‹åŠ¨è§¦å‘ |

#### Review æµç¨‹æ‰§è¡Œ

æ— è®ºæ˜¯ `/review` è¿˜æ˜¯ç”¨æˆ·é€‰æ‹© Yesï¼Œéƒ½æ‰§è¡Œä»¥ä¸‹æµç¨‹ï¼š

1. è°ƒç”¨ `mcp__code-review__get_review` è·å– Codex åé¦ˆ
2. æ ¹æ®è¿”å›çš„ status å¤„ç†ï¼š
   - `has_issues`: Claude Code ä¿®æ”¹ä»£ç ï¼Œå†æ¬¡è°ƒç”¨ review
   - `needs_human`: å±•ç¤ºé—®é¢˜ç»™ç”¨æˆ·ï¼Œç­‰å¾…å›ç­”
   - `approved`: å‘Šè¯‰ç”¨æˆ· "Code review é€šè¿‡ï¼"
   - `max_iterations`: å‘Šè¯‰ç”¨æˆ·å·²è¾¾ 10 è½®ä¸Šé™
3. å¾ªç¯ç›´åˆ°ç»ˆæ­¢æ¡ä»¶

---

### MCP Server æ¥å£è®¾è®¡

#### Tool 1: `review_code`

```typescript
{
  name: "review_code",
  description: "ä½¿ç”¨ Codex å¯¹æŒ‡å®šæ–‡ä»¶è¿›è¡Œ code review",
  parameters: {
    files: string[],           // è¦å®¡æŸ¥çš„æ–‡ä»¶è·¯å¾„åˆ—è¡¨
    context?: string,          // é¢å¤–ä¸Šä¸‹æ–‡ï¼ˆå¦‚ï¼šè¿™æ˜¯ä»€ä¹ˆåŠŸèƒ½ï¼‰
    focus_areas?: string[]     // é‡ç‚¹å…³æ³¨é¢†åŸŸï¼ˆå¦‚ï¼šsecurity, performanceï¼‰
  },
  returns: {
    status: "has_feedback" | "approved" | "needs_human_input",
    iteration: number,
    feedback?: string,
    questions?: string[],      // éœ€è¦äººç±»å›ç­”çš„é—®é¢˜
    summary: string
  }
}
```

#### Tool 2: `review_diff`

```typescript
{
  name: "review_diff",
  description: "å¯¹ git diff æˆ–ä»£ç å˜æ›´è¿›è¡Œ review",
  parameters: {
    diff: string,              // diff å†…å®¹æˆ– "staged" / "unstaged"
    context?: string
  },
  returns: {
    // åŒä¸Š
  }
}
```

#### Tool 3: `answer_review_question`

```typescript
{
  name: "answer_review_question",
  description: "å›ç­” code review è¿‡ç¨‹ä¸­çš„ open question",
  parameters: {
    question_id: string,
    answer: string
  },
  returns: {
    status: "continue_review" | "review_complete",
    next_feedback?: string
  }
}
```

### çŠ¶æ€ç®¡ç†

```typescript
interface ReviewSession {
  review_id: string;              // æœ¬æ¬¡ review çš„å”¯ä¸€ ID
  claude_session_id: string;      // å…³è”çš„ Claude Code session ID
  project_path: string;           // é¡¹ç›®è·¯å¾„
  files: string[];
  iteration: number;
  max_iterations: number;         // default: 10
  history: ReviewIteration[];
  pending_questions: Question[];
  status: "in_progress" | "approved" | "max_iterations" | "aborted";
}

interface ReviewIteration {
  iteration: number;
  codex_feedback: string;
  claude_changes?: string;
  human_answers?: Record<string, string>;
  timestamp: Date;
}
```

### è·å– Claude Code Session ID

Claude Code çš„ session æ–‡ä»¶å­˜å‚¨åœ¨ `~/.claude/projects/{project-path}/` ç›®å½•ä¸‹ã€‚

```
~/.claude/projects/-Users-yumin-ventures-ai-stack-clean-code-agent/
â”œâ”€â”€ 22c259d1-9308-41ff-8092-a7bacf6805a5.jsonl   # ä¸» session
â”œâ”€â”€ agent-a64e10b.jsonl                           # å­ agent session
â”œâ”€â”€ agent-ab1e10f.jsonl
â””â”€â”€ agent-ac5786d.jsonl
```

**è·å–å½“å‰ session ID çš„æ–¹æ³•**ï¼š

```typescript
import * as fs from 'fs';
import * as path from 'path';
import * as os from 'os';

function getCurrentClaudeSessionId(projectPath: string): string | null {
  // å°†è·¯å¾„è½¬æ¢ä¸º Claude Code çš„ç›®å½•æ ¼å¼
  const projectDir = path.join(
    os.homedir(),
    '.claude/projects',
    projectPath.replace(/^\//g, '').replace(/\//g, '-')
  );

  if (!fs.existsSync(projectDir)) {
    return null;
  }

  // æ‰¾æœ€è¿‘ä¿®æ”¹çš„ .jsonl æ–‡ä»¶ï¼ˆæ’é™¤ agent- å¼€å¤´çš„å­ agentï¼‰
  const files = fs.readdirSync(projectDir)
    .filter(f => f.endsWith('.jsonl') && !f.startsWith('agent-'))
    .map(f => ({
      name: f,
      mtime: fs.statSync(path.join(projectDir, f)).mtime
    }))
    .sort((a, b) => b.mtime.getTime() - a.mtime.getTime());

  return files[0]?.name.replace('.jsonl', '') || null;
}

// ä½¿ç”¨ç¤ºä¾‹
const sessionId = getCurrentClaudeSessionId('/Users/yumin/ventures/ai-stack/clean-code-agent');
// => "22c259d1-9308-41ff-8092-a7bacf6805a5"
```

**å…³è”ä»·å€¼**ï¼š
- å¯ä»¥è¿½æº¯"è¿™æ¬¡ code review æ˜¯å“ªæ¬¡ Claude Code å¯¹è¯è§¦å‘çš„"
- å¯ä»¥ä» Claude Code çš„ session æ–‡ä»¶ä¸­è¯»å–å¯¹è¯å†å²ï¼Œäº†è§£ä»£ç ä¿®æ”¹çš„ä¸Šä¸‹æ–‡
- ä¾¿äºè°ƒè¯•å’Œå®¡è®¡

---

## Review ç²’åº¦

**ç­–ç•¥**ï¼šReview æ‰€æœ‰å·²æ”¹åŠ¨çš„æ–‡ä»¶ï¼ˆå®Œæ•´æ–‡ä»¶å†…å®¹ï¼Œè€Œéä»… diffï¼‰

```bash
# è·å–æ”¹åŠ¨çš„æ–‡ä»¶åˆ—è¡¨
git diff --name-only HEAD~1   # æœ€è¿‘ä¸€æ¬¡æäº¤æ”¹åŠ¨çš„æ–‡ä»¶
git diff --name-only          # æœªæäº¤çš„æ”¹åŠ¨æ–‡ä»¶
git status --porcelain        # æ‰€æœ‰æ”¹åŠ¨ï¼ˆåŒ…æ‹¬ untrackedï¼‰
```

**ä¸ºä»€ä¹ˆé€‰æ‹©å®Œæ•´æ–‡ä»¶è€Œé diff**ï¼š
- Codex å¯ä»¥çœ‹åˆ°å®Œæ•´ä¸Šä¸‹æ–‡ï¼Œå‘ç°æ›´å¤šé—®é¢˜
- é¿å…å›  diff ç‰‡æ®µç¼ºå°‘ä¸Šä¸‹æ–‡è€Œè¯¯åˆ¤
- å¯ä»¥æ£€æµ‹æ–‡ä»¶çº§åˆ«çš„æ¶æ„é—®é¢˜

---

## å†å²æŒä¹…åŒ–

### åˆ†å±‚å­˜å‚¨æ–¹æ¡ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Storage Abstraction                       â”‚
â”‚  interface ReviewStorage {                                   â”‚
â”‚    save(session: ReviewSession): Promise<void>              â”‚
â”‚    load(sessionId: string): Promise<ReviewSession>          â”‚
â”‚    list(projectId: string): Promise<ReviewSession[]>        â”‚
â”‚    search(query: string): Promise<ReviewSession[]>          â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LocalStorage   â”‚  â”‚  SQLiteStorage  â”‚  â”‚  TiDBStorage    â”‚
â”‚  (JSON files)   â”‚  â”‚  (local db)     â”‚  â”‚  (cloud)        â”‚
â”‚  é»˜è®¤ï¼Œé›¶é…ç½®    â”‚  â”‚  å¯é€‰           â”‚  â”‚  å¯é€‰           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ–¹æ¡ˆ 1: æœ¬åœ° JSON æ–‡ä»¶ï¼ˆé»˜è®¤ï¼‰

```
.clean-code-agent/
â”œâ”€â”€ sessions/
â”‚   â”œâ”€â”€ 2024-01-15-abc123.json
â”‚   â””â”€â”€ 2024-01-16-def456.json
â””â”€â”€ config.json
```

**ä¼˜ç‚¹**ï¼šé›¶é…ç½®ï¼Œç«‹å³å¯ç”¨ï¼Œå¯è·Ÿéšé¡¹ç›®æäº¤åˆ° Git

### æ–¹æ¡ˆ 2: TiDB Cloudï¼ˆå¯é€‰å‡çº§ï¼‰

```typescript
// é…ç½®æ–¹å¼
{
  "storage": {
    "type": "tidb",
    "connection": {
      "host": "gateway01.us-west-2.prod.aws.tidbcloud.com",
      "port": 4000,
      "user": "xxx",
      "password": "${TIDB_PASSWORD}",  // ä»ç¯å¢ƒå˜é‡è¯»å–
      "database": "code_review"
    }
  }
}
```

**è¡¨ç»“æ„**ï¼š

```sql
CREATE TABLE review_sessions (
  id VARCHAR(36) PRIMARY KEY,
  project_path VARCHAR(512),
  files JSON,
  iteration INT,
  status ENUM('in_progress', 'approved', 'max_iterations', 'aborted'),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE review_iterations (
  id VARCHAR(36) PRIMARY KEY,
  session_id VARCHAR(36),
  iteration INT,
  codex_feedback TEXT,
  claude_changes TEXT,
  human_answers JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (session_id) REFERENCES review_sessions(id)
);

-- ä¾¿äºæœç´¢çš„ç´¢å¼•
CREATE INDEX idx_project ON review_sessions(project_path);
CREATE INDEX idx_status ON review_sessions(status);
CREATE FULLTEXT INDEX idx_feedback ON review_iterations(codex_feedback);
```

### æ¨èå®ç°é¡ºåº

1. **Phase 1**ï¼šå…ˆç”¨æœ¬åœ° JSON æ–‡ä»¶ï¼Œå¿«é€ŸéªŒè¯æµç¨‹
2. **Phase 2**ï¼šæŠ½è±¡ Storage æ¥å£
3. **Phase 3**ï¼šå®ç° TiDB é€‚é…å™¨

### Memory çš„ä»·å€¼

ä¿å­˜å†å²çš„å¥½å¤„ï¼š
- **å­¦ä¹ æ¨¡å¼**ï¼šåˆ†æå“ªäº›ç±»å‹çš„é—®é¢˜åå¤å‡ºç°
- **è·¨é¡¹ç›®çŸ¥è¯†**ï¼šæŸä¸ªé¡¹ç›®çš„ç»éªŒå¯ä»¥å¸®åŠ©å…¶ä»–é¡¹ç›®
- **å®¡è®¡è¿½æº¯**ï¼šå›é¡¾ä»£ç æ˜¯å¦‚ä½•æ¼”è¿›çš„
- **æ•ˆæœè¯„ä¼°**ï¼šç»Ÿè®¡ review çš„æœ‰æ•ˆæ€§ï¼ˆå¤šå°‘é—®é¢˜è¢«ä¿®å¤ï¼‰

---

## Human-in-the-Loop è®¾è®¡

### è§¦å‘æ¡ä»¶

Codex è¿”å›çš„ feedback ä¸­åŒ…å«ï¼š
- æ˜ç¡®çš„é—®é¢˜ï¼ˆå¦‚ï¼š"è¿™ä¸ªå‡½æ•°çš„é¢„æœŸè¡Œä¸ºæ˜¯ä»€ä¹ˆï¼Ÿ"ï¼‰
- éœ€è¦æ¾„æ¸…çš„è®¾è®¡å†³ç­–
- äºŒé€‰ä¸€æˆ–å¤šé€‰ä¸€çš„æ–¹æ¡ˆå»ºè®®

### å®ç°æ–¹å¼

1. **MCP è¿”å›é—®é¢˜**ï¼šå½“æ£€æµ‹åˆ° open questions æ—¶ï¼ŒMCP å·¥å…·è¿”å› `needs_human_input` çŠ¶æ€
2. **Claude Code è½¬é—®ç”¨æˆ·**ï¼šClaude Code å°†é—®é¢˜å±•ç¤ºç»™ç”¨æˆ·
3. **ç”¨æˆ·å›ç­”**ï¼šç”¨æˆ·åœ¨ Claude Code ä¸­å›ç­”
4. **ç»§ç»­å®¡æŸ¥**ï¼šClaude Code è°ƒç”¨ `answer_review_question` ç»§ç»­æµç¨‹

### ç¤ºä¾‹äº¤äº’

```
Claude Code: æˆ‘å®Œæˆäº†ç™»å½•åŠŸèƒ½çš„å®ç°ï¼Œè®©æˆ‘è°ƒç”¨ Codex è¿›è¡Œ review...

[è°ƒç”¨ review_code]

MCP è¿”å›: {
  status: "needs_human_input",
  questions: [
    "ç™»å½•å¤±è´¥æ—¶ï¼Œæ˜¯å¦éœ€è¦æ˜¾ç¤ºå…·ä½“çš„é”™è¯¯åŸå› ï¼ˆå¦‚'å¯†ç é”™è¯¯'ï¼‰ï¼Œè¿˜æ˜¯ç»Ÿä¸€æ˜¾ç¤º'ç™»å½•å¤±è´¥'ä»¥é˜²æ­¢ç”¨æˆ·åæšä¸¾æ”»å‡»ï¼Ÿ"
  ]
}

Claude Code: Codex åœ¨å®¡æŸ¥æ—¶æœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦ä½ å›ç­”ï¼š
  ç™»å½•å¤±è´¥æ—¶ï¼Œæ˜¯å¦éœ€è¦æ˜¾ç¤ºå…·ä½“çš„é”™è¯¯åŸå› ...è¿˜æ˜¯ç»Ÿä¸€æ˜¾ç¤º'ç™»å½•å¤±è´¥'ï¼Ÿ

User: ç»Ÿä¸€æ˜¾ç¤º'ç™»å½•å¤±è´¥'ï¼Œå®‰å…¨ä¼˜å…ˆ

Claude Code: [è°ƒç”¨ answer_review_question]

[ç»§ç»­ review æµç¨‹...]
```

---

## ç»ˆæ­¢æ¡ä»¶

| æ¡ä»¶ | åŠ¨ä½œ | è¿”å›ä¿¡æ¯ |
|------|------|----------|
| Codex æ— æ”¹è¿›å»ºè®® | æ­£å¸¸ç»ˆæ­¢ | "Code review é€šè¿‡ï¼Œæ— æ”¹è¿›å»ºè®®" |
| è¾¾åˆ° 10 è½®è¿­ä»£ | å¼ºåˆ¶ç»ˆæ­¢ | "å·²è¾¾æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œæœ€ååé¦ˆï¼š{feedback}" |
| ç”¨æˆ·ä¸»åŠ¨ç»ˆæ­¢ | ä¸­æ­¢ | "ç”¨æˆ·ä¸­æ­¢ review" |
| Codex CLI é”™è¯¯ | å¼‚å¸¸ç»ˆæ­¢ | "Codex è°ƒç”¨å¤±è´¥ï¼š{error}" |

---

## æ–‡ä»¶ç»“æ„

```
clean-code-agent/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ mcp-server/
â”‚   â”‚   â”œâ”€â”€ index.ts              # MCP Server å…¥å£
â”‚   â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â”‚   â”œâ”€â”€ review-code.ts    # review_code å·¥å…·å®ç°
â”‚   â”‚   â”‚   â”œâ”€â”€ review-diff.ts    # review_diff å·¥å…·å®ç°
â”‚   â”‚   â”‚   â””â”€â”€ answer-question.ts
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ codex-cli.ts      # Codex CLI å°è£…
â”‚   â”‚   â”‚   â”œâ”€â”€ orchestrator.ts   # æµç¨‹åè°ƒå™¨
â”‚   â”‚   â”‚   â””â”€â”€ parser.ts         # è¾“å‡ºè§£æå™¨
â”‚   â”‚   â””â”€â”€ state/
â”‚   â”‚       â””â”€â”€ session.ts        # ä¼šè¯çŠ¶æ€ç®¡ç†
â”‚   â””â”€â”€ prompts/
â”‚       â””â”€â”€ review-prompt.txt     # Codex review çš„ prompt æ¨¡æ¿
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ PRD.md                    # æœ¬æ–‡æ¡£
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

---

## Codex CLI è°ƒç”¨æ–¹å¼

### æ–¹å¼ 1: `codex review` (æ¨èç”¨äº diff review)

```bash
# Review uncommitted changes
codex review --uncommitted

# Review against base branch
codex review --base main

# Review specific commit
codex review --commit abc123

# With custom instructions
codex review --uncommitted "Focus on security issues"
```

### æ–¹å¼ 2: `codex exec --json` (æ¨èç”¨äºç»“æ„åŒ–è¾“å‡º)

```bash
# éäº¤äº’å¼æ‰§è¡Œï¼Œè¾“å‡º JSONL
codex exec --json "Review these files for issues: src/auth/*.ts"

# ä½¿ç”¨ output-schema è·å–ç»“æ„åŒ–è¾“å‡º
codex exec --output-schema review-schema.json "Review the code"

# è¾“å‡ºæœ€åæ¶ˆæ¯åˆ°æ–‡ä»¶
codex exec -o /tmp/review-result.txt "Review the code"
```

### å…³é”®å‚æ•°

| å‚æ•° | è¯´æ˜ |
|------|------|
| `--json` | è¾“å‡º JSONL æ ¼å¼ï¼Œä¾¿äºè§£æ |
| `--output-schema` | æŒ‡å®šè¾“å‡º JSON Schema |
| `-o, --output-last-message` | å°†æœ€åæ¶ˆæ¯å†™å…¥æ–‡ä»¶ |
| `--full-auto` | è‡ªåŠ¨æ‰§è¡Œï¼Œæ— éœ€ç¡®è®¤ |
| `-C, --cd` | æŒ‡å®šå·¥ä½œç›®å½• |

---

## æŠ€æœ¯å®ç°ç»†èŠ‚

### Review Output Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "status": {
      "type": "string",
      "enum": ["approved", "has_issues", "needs_clarification"]
    },
    "issues": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "severity": { "enum": ["critical", "warning", "suggestion"] },
          "file": { "type": "string" },
          "line": { "type": "integer" },
          "message": { "type": "string" },
          "suggested_fix": { "type": "string" }
        }
      }
    },
    "questions": {
      "type": "array",
      "items": { "type": "string" }
    },
    "summary": { "type": "string" }
  }
}
```

---

## Claude Code MCP é…ç½®

åœ¨ `~/.claude/claude_desktop_config.json` æˆ–é¡¹ç›® `.mcp.json` ä¸­æ·»åŠ ï¼š

```json
{
  "mcpServers": {
    "code-review": {
      "command": "node",
      "args": ["/path/to/clean-code-agent/dist/index.js"],
      "env": {
        "CODEX_PATH": "codex",
        "MAX_ITERATIONS": "10"
      }
    }
  }
}
```

---

## ä½¿ç”¨ç¤ºä¾‹

### Claude Code ä¸­è°ƒç”¨

```
User: å¸®æˆ‘å®ç°ä¸€ä¸ªç”¨æˆ·ç™»å½•åŠŸèƒ½

Claude Code: [å®ç°ä»£ç ...]

Claude Code: ä»£ç å†™å®Œäº†ï¼Œè®©æˆ‘è°ƒç”¨ Codex è¿›è¡Œ review

[è°ƒç”¨ MCP tool: review_code]

MCP è¿”å›:
{
  "status": "has_issues",
  "iteration": 1,
  "issues": [
    {
      "severity": "critical",
      "file": "src/auth/login.ts",
      "line": 45,
      "message": "å¯†ç æœªåŠ å¯†å­˜å‚¨"
    }
  ]
}

Claude Code: Codex å‘ç°äº†ä¸€ä¸ªä¸¥é‡é—®é¢˜ï¼šå¯†ç æœªåŠ å¯†å­˜å‚¨ã€‚è®©æˆ‘ä¿®å¤...

[ä¿®å¤ä»£ç ]

Claude Code: ä¿®å¤å®Œæˆï¼Œå†æ¬¡è°ƒç”¨ review...

[è°ƒç”¨ MCP tool: review_code]

MCP è¿”å›:
{
  "status": "approved",
  "iteration": 2,
  "summary": "LGTM - æ‰€æœ‰é—®é¢˜å·²ä¿®å¤"
}

Claude Code: Code review é€šè¿‡ï¼
```

---

## ä¸‹ä¸€æ­¥

1. åˆ›å»º MCP Server é¡¹ç›®
2. å®ç° codex CLI wrapper
3. å®ç° review_code å’Œ review_diff tools
4. æµ‹è¯•ç«¯åˆ°ç«¯æµç¨‹
